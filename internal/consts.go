package internal

import (
	"encoding/hex"
	"fmt"
)

func mustDecodeHex(s string) []byte {
	b, err := hex.DecodeString(s)
	if err != nil {
		panic(fmt.Sprintf("invalid hex string: %s", s))
	}
	return b
}

// TODO: Fetch these dynamically from GCS bucket
// Latest firmware file from gs://gce_tcb_integrity/ovmf_x64_csm
const LatestFirmwareFile = "84899aed3c9e87675ff809f5fea3e6f8873553d1f0100ddb9ae332692825acce738f45bdec278a4098d1c27e49537143"

// Latest filename from gs://gce_tcb_integrity/ovmf_x64_csm/tdx (without .binarypb extension)
const LatestMRTD = "fd4eda3653e0179b19655716effba08b1285eeb810196a4653a9e23b62e2f1b671df3e5f37ad821897782be807a85acf"

// Hardcoded SHA384 hashes of UEFI binaries
var (
	boot0001Hash = mustDecodeHex("A25333C7AEC2E0993034938C7F11893B3C2BCAF67E88C342A3D586F6F7FAE2C6A1247A9ED86988080A6D4BE497D4FBB6")
	boot0000Hash = mustDecodeHex("23ADA07F5261F12F34A0BD8E46760962D6B4D576A416F1FEA1C64BC656B1D28EACF7047AE6E967C58FD2A98BFA74C298")
)

// Hardcoded SHA384 hashes of TDX EFI variables
var (
	secureBootHash = mustDecodeHex("CFA4E2C606F572627BF06D5669CC2AB1128358D27B45BC63EE9EA56EC109CFAFB7194006F847A6A74B5EAED6B73332EC")
	pkHash         = mustDecodeHex("905F6243BAF0D7C63CD672F89B16E15F99597E8D0392955E685172D447100123F7C490D178543922FADDF896625DABAB")
	kekHash        = mustDecodeHex("BE013B0D9188E72B870F598899C35864D6B25F029A7B5F21A037BACF61CA3646207AF2BC714D471407C9939317763C4A")
	dbHash         = mustDecodeHex("723AD4D64F430BF6D325AB9D6C29147993DED5630002E42E13DF696EBC680C4BC14C392D2E113E141154E21723F890F6")
	dbxHash        = mustDecodeHex("C61BAE1A3F7B7E6CC3B9B03F630B77292EBD232AE60E0E1916F980955EC38459529574B49F1898C367EAF6D8A62311F5")
)

// Hardcoded SHA384 hashes of other UEFI components
var (
	venMediaHash = mustDecodeHex("EBFFE1DECB1752C23908F3A59C2C20E94C4923EE04B2E9CF559538092BD0B0796BCB592E7252C5D71EAAA0EEBC6AFA66")
)

// configurationEvents maps machine configuration to hardcoded TD HOB and ACPI table hashes
type configurationEvents struct {
	TdHobHash      []byte
	AcpiTablesHash []byte
	AcpiRsdpHash   []byte
	AcpiLoaderHash []byte
}

var machineConfigurations = map[string]configurationEvents{
	"c3-standard-4": {
		TdHobHash:      mustDecodeHex("458994DAA60DEAC8DEA19DBA79748F6FF93FD0AEBB8E3E0BE5A65EB12309D342C3CE31CC67AF7BBD22AF1A44E7D9FE21"),
		AcpiTablesHash: mustDecodeHex("F29E022D067DA7289C935EEC2477C46032F2E0659A11E658F0AE05068AEA420189E77E302B715084DACC7C0C4C118EA6"),
		AcpiRsdpHash:   mustDecodeHex("509DCFE10BEB5D470C40F25E30895370948831B9CF79DB15D977E7BBA8EB42F7200212071AD8B19D6011759779ECED5A"),
		AcpiLoaderHash: mustDecodeHex("0F0B426CBD5BD9C2A4A5E640E6C4556B8DF071DCC973DCF95465AE5514C0EBA6DC960A6B7B21D29099CADA75DC1B46D5"),
	},
	"c3-standard-8": {
		TdHobHash:      mustDecodeHex("AA9E81FEEB58A9EB3A9F4110CC7B5696240437EA4C1A9C30518CFC44FA305183E6473E6BC02DDC4DE09D0C49C49FADB5"),
		AcpiTablesHash: mustDecodeHex("65B39FEC4F65FE6F1F03A9525AF00B38D8C285EA7697B75A267AA671A9B2B10907138BD6DA63E10C37997D689AD95421"),
		AcpiRsdpHash:   mustDecodeHex("4274FEDFA6ABEFE0062C5734FF82CD2C9092CDB51134EC4762D5C802D743316C9F0CDAA497A843811D0D5620CC252562"),
		AcpiLoaderHash: mustDecodeHex("1AC9F951EEE9D683C797EAC588B786C5D1FA140F4E69ADE6DC2A4537900E3257A4F172F03EC722C7349F8E6636EDD05F"),
	},
}

// GetAllConfigurations returns a list of all available machine configurations
func GetAllConfigurations() []string {
	configs := make([]string, 0, len(machineConfigurations))
	for config := range machineConfigurations {
		configs = append(configs, config)
	}
	return configs
}
